<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Air quality data from archive.luftdaten.info</title>
        <link rel="stylesheet" href="style.css" type="text/css">
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		
        <script src="./lib/amcharts/amcharts.js" type="text/javascript"></script>
        <script src="./lib/amcharts/serial.js" type="text/javascript"></script>
		<script src="./lib/amcharts/amstock.js" type="text/javascript"></script>
		<script src="./lib/amcharts/plugins/dataloader/dataloader.min.js" type="text/javascript"></script>
		
		<script src="https://momentjs.com/downloads/moment.js"></script>
		<script src="./script/rsvp.js"></script>

		<script>

    $(document).ready(function(){
        $("button").click(function(){
		
		    //declarations =============================================================================================
		   	var chart;
            var chartData = [];
            var chartCursor;
			var legend_left="";
			
			var sensor_name = $('#sensorTxt').val();
			var days_back = parseInt($('#daysBeforeTxt').val());
			var is_pm_10 = $("#radioPM10").is(":checked");
			var time_zone_shift = parseInt($('#sensorTimeZone').val());

			if (is_pm_10) legend_left = "PM 10"; else legend_left = "PM 2.5";
			
            //http://api.luftdaten.info/static/v1/data/data.json.2017-06-03-02-00
		    
			//get data =============================================================================================
			var result = "";
			var times = [];
			for(h=0; h<=1; h++) //23
			{
			    var hour = h;
				if (hour <=9) hour = "0" + hour;
				
				for(m=0; m<=55; m=m+5)
				{
				   var minute = m;
				   if (minute <=9) minute = "0" + minute;
				   
				    times.push(hour + "-" + minute); 
					//console.log(hour + "-" + minute);
				}
			}
			
			console.log("Files: " + times.length);
			
			var promises = times.map(function(id){
			  var file = "http://api.luftdaten.info/static/v1/data/data.json.2017-06-01-" + id;
			  console.log(file);
			  return jQuery.getJSON(file);
			});

			RSVP.all(promises).then(function(posts) {
			  // posts contains an array of results for the given promises
			  for(i=0; i< posts.length; i++)
			  {
			       result += posts[i];
				   
				   var arr = $.map(posts[i], function(el) { return el });

				   var arrByID = filterItems(arr, sensor_name);
				   
				   for (i = 0; i < arrByID.length; i++)
				   {
					   var visits = arrByID[i].sensordatavalues[0].value;
					   //fill data values
					   console.log(visits);
				   }
					
				   //console.log(arrByID[0].sensor.id);
			  }
			  console.log("done processing");
			  
			}).catch(function(reason){
			  console.log("Promise json get data error: " + reason);
			});
			
			//show data =============================================================================================
			var chart = AmCharts.makeChart("chartdiv", {
				"type": "serial",
				"theme": "light",
				"marginRight": 80,
				"dataProvider": chartData,
				"valueAxes": [{
					"position": "left",
					"title": legend_left
				}],
				"graphs": [{
					"id": "g1",
					"fillAlphas": 0.4,
					"valueField": "value",
					 "balloonText": "<div style='margin:5px; font-size:19px;'>Value:<b>[[value]]</b></div>"
				}],
				"chartScrollbar": {
					"graph": "g1",
					"scrollbarHeight": 80,
					"backgroundAlpha": 0,
					"selectedBackgroundAlpha": 0.1,
					"selectedBackgroundColor": "#888888",
					"graphFillAlpha": 0,
					"graphLineAlpha": 0.5,
					"selectedGraphFillAlpha": 0,
					"selectedGraphLineAlpha": 1,
					"autoGridCount": true,
					"color": "#AAAAAA"
				},
				"chartCursor": {
					"categoryBalloonDateFormat": "JJ:NN, DD MMMM",
					"cursorPosition": "mouse"
				},
				"categoryField": "date",
				"categoryAxis": {
					"minPeriod": "mm",
					"parseDates": true
				},
				"export": {
					"enabled": true,
					 "dateFormat": "YYYY-MM-DD HH:NN:SS"
				}
			}); //end amChart creat
			
	   }); //button click
	}); //ready			
			
			
			function getRemote(remote_url) {
				return $.ajax({
					type: "GET",
					url: remote_url,
					async: false //on purpose, because we can not continue until all files are downloaded
				}).responseText;
			}
			
			function isNumber(obj) {
			  return obj!== undefined && typeof(obj) === 'number' && !isNaN(obj);
			}
			
			function filterItems(arr, query) {
			  return arr.filter(function(el) {
				  return el.sensor.id = query;
			})
			};

			function filterByID(item) {
			  if (isNumber(item.id)) {
				return true;
			  } 
			  //invalidEntries++;
			  return false; 
			}

        </script>
    </head>

    <body>
	    <table style="width: 100%;">
		  <tr align="left">
		      <td>SDS011 sensor map ID: <input name="sensorTxt" type="text" maxlength="8" id="sensorTxt" value="227" /></td>
			  <td>Sensor time zone: +<input name="sensorTimeZone" type="text" maxlength="8" id="sensorTimeZone" value="0" /></td>
			  <td>For the last: <input name="daysBeforeTxt" type="text" maxlength="8" id="daysBeforeTxt" value="3"/> days</td>
			  <td> PM 10 <input type="radio" name="group1" id="radioPM10" value="pm10">
				   PM 2.5 <input type="radio" name="group1" id="radioPM25" value="pm25" checked="checked">
			  </td> 
			  <td><button type="button">Process</button></td>
		  </tr>
		  <tr>
			  <td colspan="5">
			     <div id="chartdiv" style="width: 100%; height: 450px;"></div>
			  </td>
		  <tr>
    </body>

</html>